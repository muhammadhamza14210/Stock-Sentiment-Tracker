name: Safe 30-Hour Interval Run

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours (UTC)
  push:
    branches:
      - main

jobs:
  run-safe:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    - name: Create GCP credentials file
      run: echo '${{ secrets.GCP_KEY_JSON }}' > gcp_key.json

    - name: Load last run timestamp and decide
      id: check_run
      run: |
        FILE=last_run.txt
        NOW=$(date +%s)
        GAP=108000  # 30 hours in seconds

        if [ -f "$FILE" ]; then
          LAST_RUN=$(cat $FILE)
          DIFF=$((NOW - LAST_RUN))
          echo "🕒 Last run was $((DIFF/3600)) hours ago."

          if [ $DIFF -lt $GAP ]; then
            echo "⏳ Less than 30 hours. Skipping run."
            exit 0
          fi
        else
          echo "🔔 First run or no timestamp found."
        fi

        echo $NOW > $FILE

    - name: Run Docker job
      run: |
        docker build -t stock-sentiment-tracker .
        docker run \
          -e GOOGLE_APPLICATION_CREDENTIALS='/app/gcp_key.json' \
          -e NEWS_API="${{ secrets.NEWS_API }}" \
          stock-sentiment-tracker

    - name: Commit updated timestamp
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git add last_run.txt
        git commit -m "Update last run timestamp"
        git push
